<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro de Entrenamiento — Series múltiples + Mejor peso (por ejercicio) + Enlaces YouTube</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  /* ======= PALETA AZUL + BLANCO ======= */
  :root{
    --bg:#0f172a;            /* Slate-900 */
    --panel:#0b1228;         /* panel base */
    --panel-2:#111a37;       /* panel inputs */
    --text:#e6f4ff;          /* Blanco azulado para mejor contraste */
    --muted:#99b3cc;         /* Texto neutro */
    --brand:#0ea5e9;         /* Sky-500 para botones */
    --brand-2:#38bdf8;       /* Sky-400 para degradados */
    --link:#ffffff;          /* Enlace principal (blanco) */
    --link-hover:#38bdf8;    /* Hover azul claro */
    --card:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
    --shadow:0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
    --radius:16px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7fbff;          /* fondo muy claro azuloso */
      --panel:#ffffff;
      --panel-2:#eef6ff;     /* inputs muy claros */
      --text:#0b1726;        /* texto oscuro */
      --muted:#3a536d;       /* neutro oscuro */
      --brand:#0284c7;       /* Sky-600 */
      --brand-2:#38bdf8;
      --link:#0b61d6;        /* azul fuerte para luz */
      --link-hover:#0ea5e9;  /* azul claro al hover */
      --shadow:0 8px 28px rgba(2,6,23,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
    }
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji'; background:radial-gradient(1000px 600px at 80% -10%, rgba(56,189,248,0.22), transparent), var(--bg); color:var(--text)}
  header{position:sticky; top:0; z-index:20; backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0)); border-bottom:1px solid rgba(148,163,184,0.12)}
  .wrap{max-width:1100px; margin:0 auto; padding:24px}
  .head{display:grid; grid-template-columns: 1fr auto; gap:16px; align-items:center}
  .title{display:flex; gap:14px; align-items:center}
  .logo{width:44px; height:44px; border-radius:12px; display:grid; place-items:center; background: conic-gradient(from 220deg, rgba(14,165,233,0.85), rgba(56,189,248,0.65)); box-shadow:var(--shadow)}
  .logo svg{filter: drop-shadow(0 2px 6px rgba(56,189,248,0.45));}
  h1{font-size:clamp(20px,2.4vw,28px); margin:0; letter-spacing:0.2px}
  .subtitle{color:var(--muted); font-size:14px}
  .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end}
  .pill{display:inline-flex; align-items:center; gap:10px; background:var(--panel-2); padding:10px 14px; border-radius:999px; border:1px solid rgba(148,163,184,0.16)}
  input[type="date"], select{background:transparent; color:var(--text); border:none; outline:none; font:inherit}
  select option{color:#0f172a}
  .btn{cursor:pointer; user-select:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; color:white; background: linear-gradient(180deg, var(--brand), #0369a1); box-shadow: var(--shadow)}
  .btn.secondary{background: linear-gradient(180deg, #1e293b, #0b1228); color:var(--text)}
  .btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(148,163,184,0.22)}
  .grid{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:18px}
  .card{background: var(--card); border-radius: var(--radius); border:1px solid rgba(148,163,184,0.16); box-shadow: var(--shadow)}
  .card .inner{padding:18px}
  .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; background:rgba(2,6,23,0.35)}
  thead th{position:sticky; top:0; background: rgba(2,6,23,0.6); color:var(--muted); font-weight:600; text-align:left; padding:12px; border-bottom:1px solid rgba(148,163,184,0.18)}
  tbody td{padding:12px; border-bottom:1px dashed rgba(148,163,184,0.14); vertical-align:middle}
  tbody tr:hover{background: rgba(56,189,248,0.06)}
  .ex-cell{display:flex; align-items:center; gap:12px}
  .thumb{width:52px; height:52px; border-radius:10px; overflow:hidden; background:#0b1228; border:1px solid rgba(148,163,184,0.18); display:grid; place-items:center}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .ex-name{font-weight:700}
  .ex-link{color:var(--link); text-decoration:none}
  .ex-link:hover{color:var(--link-hover); text-decoration:underline}
  .ex-link:focus{outline:2px solid var(--link-hover); outline-offset:2px; border-radius:4px}
  .muted{color:var(--muted); font-size:12px}
  .input{display:flex; align-items:center; gap:8px; background:var(--panel-2); border:1px solid rgba(148,163,184,0.16); border-radius:10px; padding:8px 10px}
  .input input{background:transparent; border:none; outline:none; color:var(--text); width:80px; font:inherit}
  .input input[type="number"]{width:85px}
  .input input::placeholder{color:var(--muted)}
  .sets{display:flex; flex-wrap:wrap; gap:8px}
  .set{display:flex; align-items:center; gap:6px; background:rgba(2,6,23,0.35); border:1px solid rgba(148,163,184,0.18); border-radius:10px; padding:6px 8px}
  .set .rm{cursor:pointer; background:transparent; color:var(--muted); border:none; font-weight:800; padding:0 4px}
  .set .rm:hover{color:#ef4444}
  .add-set{padding:6px 10px; border-radius:10px; border:1px dashed rgba(148,163,184,0.28); background:transparent; color:var(--text); cursor:pointer}
  .add-set:hover{border-color:rgba(56,189,248,0.7)}
  .actions{display:flex; gap:8px}
  .tiny{font-size:12px; opacity:0.85}
  .footer{display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,0.18); background: rgba(2,6,23,0.35)}
  .section-title{font-weight:700; font-size:16px; margin:0 0 8px}
  .note{font-size:13px; color:var(--muted)}
  .brand-text{background: linear-gradient(45deg, var(--brand-2), white); -webkit-background-clip:text; background-clip:text; color:transparent}
  .table-wrap{overflow:auto; border-radius:12px}
  .chart-grid{display:grid; grid-template-columns: 1fr; gap:16px}
  .chart-wrap{position:relative; height:320px; background:rgba(2,6,23,0.35); border:1px solid rgba(148,163,184,0.16); border-radius:12px; padding:12px}
  .chart-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  canvas{width:100%; height:260px; display:block}
  .tooltip{position:absolute; pointer-events:none; background:rgba(2,6,23,0.92); color:#e2e8f0; border:1px solid rgba(148,163,184,0.25); border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.25; transform: translate(-50%,-120%); box-shadow:0 8px 24px rgba(0,0,0,0.35)}
  .tooltip .t-title{font-weight:700}
  .tooltip .t-sub{color:var(--muted)}
  @media (max-width:800px){ .head{grid-template-columns: 1fr} .toolbar{justify-content:flex-start} .input input[type="number"]{width:72px} }
</style>
</head>
<body>
  <header>
    <div class="wrap head">
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Logo">
            <path d="M7 7h2v10H7zM15 7h2v10h-2z" fill="#fff" opacity="0.9"/>
            <rect x="3" y="9" width="2" height="6" rx="1" fill="#fff" opacity="0.6"/>
            <rect x="19" y="9" width="2" height="6" rx="1" fill="#fff" opacity="0.6"/>
            <rect x="9" y="10.5" width="6" height="3" rx="1" fill="#fff" opacity="0.9"/>
          </svg>
        </div>
        <div>
          <h1>Registro de <span class="brand-text">Entrenamiento</span> — Rutina 6 Días</h1>
          <div class="subtitle">Series múltiples por ejercicio, progreso semanal (mejor peso por ejercicio) y enlaces a vídeos de técnica.</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="pill"><span class="muted">Fecha</span><input type="date" id="fecha" /></div>
        <div class="pill">
          <span class="muted">Plantilla</span>
          <select id="plan">
            <option value="D1">Día 1 – PUSH</option>
            <option value="D2">Día 2 – PIERNAS</option>
            <option value="D3">Día 3 – PULL</option>
            <option value="D4">Día 4 – PUSH</option>
            <option value="D5">Día 5 – PIERNAS</option>
            <option value="D6">Día 6 – PULL</option>
          </select>
        </div>
        <button class="btn" id="btn-cargar">Cargar plantilla</button>
        <button class="btn secondary" id="btn-ejercicios">Gestionar ejercicios</button>
        <button class="btn" id="btn-anadir">Añadir ejercicio</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="inner">
          <div class="section-title">Sesión</div>
          <div class="note">Pulsa el <b>nombre</b> de cada ejercicio para abrir su <b>vídeo de YouTube</b>. Si no tiene enlace guardado, se abrirá una <b>búsqueda sugerida</b>.</div>
        </div>
        <div class="table-wrap">
          <table class="table" id="tabla">
            <thead>
              <tr>
                <th style="min-width:300px">Ejercicio</th>
                <th style="min-width:120px">Objetivo</th>
                <th style="min-width:320px">Series (kg × reps)</th>
                <th style="min-width:240px">Notas</th>
                <th style="width:140px">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="5" class="muted" style="padding:18px">No hay ejercicios para esta fecha. Usa <b>Cargar plantilla</b> o <b>Añadir ejercicio</b>.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="inner footer">
          <div class="chips">
            <span class="chip">Datos locales (LocalStorage)</span>
            <span class="chip">Sin conexión</span>
            <span class="chip">Exportar/Importar JSON</span>
          </div>
          <div class="actions">
            <button class="btn ghost" id="btn-exportar">Exportar</button>
            <button class="btn ghost" id="btn-importar">Importar</button>
            <button class="btn ghost" id="btn-imprimir">Imprimir / PDF</button>
            <button class="btn ghost" id="btn-reset">Reiniciar</button>
            <input id="input-import" class="file" type="file" accept="application/json" />
          </div>
        </div>
      </div>

      <!-- Progreso semanal (solo mejor peso por ejercicio) -->
      <div class="card">
        <div class="inner">
          <div class="section-title">Progreso semanal</div>
          <div class="note">Selecciona el <b>ejercicio</b> y el intervalo. El gráfico muestra tu <b>mejor peso semanal (kg)</b> para ese ejercicio. Incluye <b>tooltips</b>.</div>
          <div class="controls" style="margin:10px 0 6px">
            <div class="pill"><span class="muted">Ejercicio</span><select id="sel-ej"><option value="">— Selecciona —</option></select></div>
            <div class="pill"><span class="muted">Semanas</span><select id="sel-weeks"><option>6</option><option selected>8</option><option>12</option><option>16</option></select></div>
            <button class="btn" id="btn-actualizar">Actualizar</button>
          </div>
        </div>
        <div class="inner chart-grid">
          <div class="chart-wrap" id="wrap-max">
            <div class="chart-head"><div style="font-weight:600">Mejor peso semanal (kg)</div><div class="muted" id="lbl-max"></div></div>
            <canvas id="chart-max"></canvas>
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- Dialogo: Gestionar ejercicios -->
  <dialog id="dlg">
    <div class="dialog-head" style="display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(148,163,184,0.16)">
      <div>
        <div class="section-title">Gestionar ejercicios</div>
        <div class="note">Crea, edita o elimina ejercicios. Puedes subir una foto y <b>guardar un enlace de YouTube</b> para técnica.</div>
      </div>
      <button class="btn ghost" id="dlg-close">Cerrar</button>
    </div>
    <div class="dialog-body" style="padding:16px 18px">
      <div class="row" style="display:flex; justify-content: space-between; align-items:center; gap:8px; margin-bottom:10px">
        <div class="search" style="display:flex; gap:8px; align-items:center">
          <div class="input"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg><input id="buscar" placeholder="Buscar ejercicio"/></div>
        </div>
        <div class="row" style="display:flex; gap:8px"><button class="btn" id="btn-nuevo">Nuevo</button></div>
      </div>
      <div class="divider" style="height:1px; background:linear-gradient(90deg, transparent, rgba(148,163,184,0.25), transparent); margin:12px 0"></div>
      <div id="lista-ejercicios"></div>
    </div>
  </dialog>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  // Intenta cargar de versiones anteriores si existen, y consolida en v7
  const KEYS_EJ=['ejercicios.v7','ejercicios.v6','ejercicios.v5','ejercicios.v4'];
  const KEYS_RG=['registros.v7','registros.v6','registros.v5','registros.v4'];
  const LS_EJ='ejercicios.v7';
  const LS_REG='registros.v7';
  const todayISO = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10) }
  const uid = ()=>Math.random().toString(36).slice(2,9);

  function tryLoad(keys){ for(const k of keys){ try{ const val=localStorage.getItem(k); if(val){ const parsed=JSON.parse(val); if(parsed && (Array.isArray(parsed) || typeof parsed==='object')) return parsed; } }catch{} } return null; }
  let ejercicios = tryLoad(KEYS_EJ) || [];
  let registros = tryLoad(KEYS_RG) || {};
  // Normaliza estructura
  if(!Array.isArray(ejercicios)) ejercicios=[];
  if(typeof registros!=='object' || !registros) registros={};
  // Garantiza campo video y guarda en clave actual
  ejercicios.forEach(e=>{ if(typeof e.video==='undefined') e.video=''; });
  localStorage.setItem(LS_EJ, JSON.stringify(ejercicios));
  localStorage.setItem(LS_REG, JSON.stringify(registros));

  const svgPlaceholder = (label)=>{
    const bg='#0b1b2b', gradA='#0ea5e9', gradB='#38bdf8'; const txt=(label||'GY').split(' ').map(x=>x[0]||'').join('').slice(0,3).toUpperCase();
    const svg=encodeURIComponent(`<?xml version='1.0' encoding='UTF-8'?>
    <svg xmlns='http://www.w3.org/2000/svg' width='240' height='240'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='${gradA}'/><stop offset='100%' stop-color='${gradB}'/></linearGradient></defs>
      <rect width='100%' height='100%' fill='${bg}'/>
      <g transform='translate(36,105)'>
        <rect x='0' y='10' width='36' height='48' rx='6' fill='url(#g)' opacity='0.9'/>
        <rect x='48' y='0' width='108' height='68' rx='10' fill='url(#g)' opacity='0.7'/>
        <rect x='168' y='10' width='36' height='48' rx='6' fill='url(#g)' opacity='0.9'/>
      </g>
      <text x='120' y='200' text-anchor='middle' font-family='Inter, Arial' font-size='28' fill='white' opacity='0.9'>${txt}</text>
    </svg>`);
    return `data:image/svg+xml;utf8,${svg}`;
  }

  // Plantillas
  const PLANTILLAS = {
    D1:{ nombre:'Día 1 – PUSH', ejercicios:[
      {nombre:'Press de banca', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Press inclinado (25–40º)', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Aperturas', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Fondos', categoria:'Pecho (extra)', objetivo:'3×8–10'},
      {nombre:'Elevaciones laterales (mancuernas)', categoria:'Hombros', objetivo:'3×8–12'},
      {nombre:'Pushdown (tríceps polea)', categoria:'Tríceps', objetivo:'3×8–20'},
      {nombre:'Extensión sobre la cabeza (tríceps polea)', categoria:'Tríceps', objetivo:'3×8–20'},
    ]},
    D2:{ nombre:'Día 2 – PIERNAS', ejercicios:[
      {nombre:'Cuádriceps (Leg Extension)', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Femoral (Leg Curl)', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Abductores (hacia afuera)', categoria:'Cadera', objetivo:'3×10–15'},
      {nombre:'Aductores (hacia dentro)', categoria:'Cadera', objetivo:'3×10–15'},
      {nombre:'Glúteos (máquina)', categoria:'Glúteos', objetivo:'3×10–15'},
      {nombre:'Gemelos', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Abdominales (Plancha y Crunch)', categoria:'Core', objetivo:'Libre'},
    ]},
    D3:{ nombre:'Día 3 – PULL', ejercicios:[
      {nombre:'Jalón al pecho (a veces agarre neutro)', categoria:'Espalda', objetivo:'4×8–12'},
      {nombre:'Remo con mancuerna a una mano', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Remo bilateral (máquina, agarre abierto)', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Remo Gironda (polea, agarre cerrado)', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Dominadas', categoria:'Espalda (extra)', objetivo:'3×5–8'},
      {nombre:'Curl inclinado (bíceps con mancuernas sentado)', categoria:'Bíceps', objetivo:'3×8–12'},
      {nombre:'Curl martillo (bíceps con mancuernas)', categoria:'Bíceps', objetivo:'3×8–12'},
    ]},
    D4:{ nombre:'Día 4 – PUSH', ejercicios:[
      {nombre:'Press de banca', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Press inclinado (25–40º)', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Aperturas', categoria:'Pecho', objetivo:'3×8–12'},
      {nombre:'Fondos', categoria:'Pecho (extra)', objetivo:'3×8–10'},
      {nombre:'Press militar (mancuernas)', categoria:'Hombros', objetivo:'3×8–12'},
      {nombre:'Press francés (tríceps con mancuernas)', categoria:'Tríceps', objetivo:'3×8–12'},
      {nombre:'Poleas cruzadas tríceps extensión', categoria:'Tríceps', objetivo:'3×8–12'},
    ]},
    D5:{ nombre:'Día 5 – PIERNAS', ejercicios:[
      {nombre:'Cuádriceps (Leg Extension)', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Femoral (Leg Curl)', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Abductores (hacia afuera)', categoria:'Cadera', objetivo:'3×10–15'},
      {nombre:'Aductores (hacia dentro)', categoria:'Cadera', objetivo:'3×10–15'},
      {nombre:'Glúteos (máquina)', categoria:'Glúteos', objetivo:'3×10–15'},
      {nombre:'Gemelos', categoria:'Piernas', objetivo:'3×10–15'},
      {nombre:'Abdominales (Plancha y Crunch)', categoria:'Core', objetivo:'Libre'},
    ]},
    D6:{ nombre:'Día 6 – PULL', ejercicios:[
      {nombre:'Jalón al pecho (a veces agarre neutro)', categoria:'Espalda', objetivo:'4×8–12'},
      {nombre:'Remo con mancuerna a una mano', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Remo bilateral (máquina, agarre abierto)', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Remo Gironda (polea, agarre cerrado)', categoria:'Espalda', objetivo:'3×8–12'},
      {nombre:'Dominadas', categoria:'Espalda (extra)', objetivo:'3×5–8'},
      {nombre:'Curl predicador (bíceps con mancuernas apoyado)', categoria:'Bíceps', objetivo:'3×8–12'},
      {nombre:'Curl martillo (bíceps con mancuernas)', categoria:'Bíceps', objetivo:'3×8–12'},
    ]},
  };

  const saveEjercicios=arr=> localStorage.setItem(LS_EJ, JSON.stringify(arr));
  const saveRegistros=obj=> localStorage.setItem(LS_REG, JSON.stringify(obj));

  function ensureDefaults(){ if((Array.isArray(ejercicios) && ejercicios.length)) return; const map=new Map(); Object.values(PLANTILLAS).forEach(p=>p.ejercicios.forEach(x=>{ const k=x.nombre.toLowerCase(); if(!map.has(k)) map.set(k,{id:uid(), nombre:x.nombre, categoria:x.categoria, objetivo:x.objetivo, imagen:svgPlaceholder(x.nombre), video:''}); })); ejercicios=Array.from(map.values()); saveEjercicios(ejercicios); }
  ensureDefaults();

  let fecha=todayISO();
  const fechaInput=$('#fecha'); fechaInput.value=fecha; fechaInput.addEventListener('change', ()=>{ fecha=fechaInput.value; renderTabla(); updatePlanSelectFromFecha(); renderChartSelectors(); renderCharts(); })
  const planSelect=$('#plan');

  // Acciones globales
  $('#btn-imprimir').addEventListener('click', ()=>window.print());
  $('#btn-reset').addEventListener('click', ()=>{ if(confirm('Esto borrará todos tus datos locales (ejercicios y registros). ¿Continuar?')){ KEYS_EJ.forEach(k=>localStorage.removeItem(k)); KEYS_RG.forEach(k=>localStorage.removeItem(k)); ejercicios=[]; registros={}; ensureDefaults(); saveEjercicios(ejercicios); saveRegistros(registros); renderTabla(); renderListaEjercicios(); renderChartSelectors(); renderCharts(); } });
  $('#btn-exportar').addEventListener('click', ()=>{ const data={ejercicios, registros}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`registro-entrenamiento-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); });
  $('#btn-importar').addEventListener('click', ()=> $('#input-import').click());
  $('#input-import').addEventListener('change', (e)=>{ const file=e.target.files?.[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data.ejercicios||!data.registros) throw new Error('Archivo no válido'); ejercicios=data.ejercicios; ejercicios.forEach(x=>{ if(typeof x.video==='undefined') x.video=''; }); registros=data.registros; saveEjercicios(ejercicios); saveRegistros(registros); renderTabla(); renderListaEjercicios(); updatePlanSelectFromFecha(); renderChartSelectors(); renderCharts(); alert('Datos importados correctamente.'); }catch(err){ alert('No se pudo importar: '+err.message) } }; reader.readAsText(file); e.target.value=''; });

  // Helpers registros por fecha
  function ensureFecha(f){ if(!registros[f]) registros[f]={ _lista:[], _plan:null }; return registros[f]; }
  function getLista(f){ return ensureFecha(f)._lista }
  function setLista(f, arr){ ensureFecha(f)._lista=arr; saveRegistros(registros) }
  function setPlan(f, code){ ensureFecha(f)._plan=code; saveRegistros(registros) }
  function getPlan(f){ return ensureFecha(f)._plan }

  function nameToId(nombre){ const e=ejercicios.find(x=>x.nombre.toLowerCase()===nombre.toLowerCase()); return e?.id }
  function idToEj(id){ return ejercicios.find(x=>x.id===id) }

  // Plantillas
  $('#btn-cargar').addEventListener('click', ()=>{ const code=planSelect.value; const p=PLANTILLAS[code]; if(!p) return; const ids=[]; p.ejercicios.forEach(x=>{ let id=nameToId(x.nombre); if(!id){ const ex={id:uid(), nombre:x.nombre, categoria:x.categoria, objetivo:x.objetivo, imagen:svgPlaceholder(x.nombre), video:''}; ejercicios.push(ex); id=ex.id; saveEjercicios(ejercicios); } else { const ex=idToEj(id); if(ex){ ex.categoria=ex.categoria||x.categoria; ex.objetivo=ex.objetivo||x.objetivo; if(typeof ex.video==='undefined') ex.video=''; } } ids.push(id); }); setLista(fecha, ids); setPlan(fecha, code); renderTabla(); renderChartSelectors(); renderCharts(); });

  // Añadir ejercicio
  $('#btn-anadir').addEventListener('click', ()=>{ const nombre=prompt('Nombre del ejercicio (si existe se añadirá, si no se creará):'); if(!nombre) return; let id=nameToId(nombre); if(!id){ const categoria=prompt('Categoría (opcional):')||''; const objetivo=prompt('Objetivo (p. ej. 3×8–12):')||''; const video=(prompt('URL YouTube (opcional):')||'').trim(); const ex={id:uid(), nombre, categoria, objetivo, imagen:svgPlaceholder(nombre), video}; ejercicios.push(ex); saveEjercicios(ejercicios); id=ex.id; } const lista=getLista(fecha); if(!lista.includes(id)){ lista.push(id); setLista(fecha, lista); } renderTabla(); renderListaEjercicios(); renderChartSelectors(); renderCharts(); });

  // Gestionar biblioteca
  const dlg=$('#dlg'); $('#btn-ejercicios').addEventListener('click', ()=>{ renderListaEjercicios(); dlg.showModal(); }); $('#dlg-close').addEventListener('click', ()=> dlg.close()); $('#buscar').addEventListener('input', ()=> renderListaEjercicios());

  function renderListaEjercicios(){ const cont=$('#lista-ejercicios'); const q=($('#buscar').value||'').toLowerCase(); const list=ejercicios.filter(e=> e.nombre.toLowerCase().includes(q) || (e.categoria||'').toLowerCase().includes(q)); cont.innerHTML=''; if(!list.length){ cont.innerHTML=`<div class='note'>No hay resultados.</div>`; return; } list.forEach(ex=>{ const row=document.createElement('div'); row.className='inner'; row.style.display='grid'; row.style.gridTemplateColumns='auto 1fr auto'; row.style.gap='14px'; row.style.alignItems='center'; const yt = ex.video && /^https?:\/\//i.test(ex.video) ? ex.video : '';
    row.innerHTML=`<div class='thumb' style='width:88px;height:88px;border-radius:12px'><img src='${ex.imagen || svgPlaceholder(ex.nombre)}' alt='${ex.nombre}'/></div><div><div style='font-weight:700'>${ex.nombre}</div><div class='muted'>${ex.categoria||''}${ex.objetivo?' • '+ex.objetivo:''}${yt? ' • <a href=\'${yt}\' target=\'_blank\' rel=\'noopener\' class=\'ex-link\'>YouTube</a>':''}</div></div><div class='actions'><button class='btn secondary' data-act='edit' data-id='${ex.id}'>Editar</button><button class='btn ghost' data-act='video' data-id='${ex.id}'>Enlace YouTube</button><button class='btn ghost' data-act='foto' data-id='${ex.id}'>Cambiar foto</button><button class='btn ghost' data-act='del' data-id='${ex.id}'>Eliminar</button></div>`; cont.appendChild(row); }); cont.querySelectorAll('button').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.dataset.id; const act=b.dataset.act; const ex=idToEj(id); if(!ex) return; if(act==='edit'){ const nombre=prompt('Nombre', ex.nombre)||ex.nombre; const categoria=prompt('Categoría', ex.categoria||'')||''; const objetivo=prompt('Objetivo', ex.objetivo||'')||''; ex.nombre=nombre; ex.categoria=categoria; ex.objetivo=objetivo; saveEjercicios(ejercicios); renderTabla(); renderListaEjercicios(); renderChartSelectors(); renderCharts(); } if(act==='video'){ const val = prompt('Pega la URL de YouTube (opcional). Si lo dejas vacío, se usará una búsqueda sugerida al pulsar el nombre.', ex.video||'') || ''; ex.video = val.trim(); saveEjercicios(ejercicios); renderTabla(); renderListaEjercicios(); } if(act==='foto'){ cambiarFoto(id); } if(act==='del'){ if(confirm('¿Eliminar este ejercicio de la biblioteca? (Las sesiones que lo usen mantendrán sus datos)')){ ejercicios=ejercicios.filter(e=>e.id!==id); Object.values(registros).forEach(r=>{ r._lista=(r._lista||[]).filter(x=>x!==id); }); saveEjercicios(ejercicios); saveRegistros(registros); renderTabla(); renderListaEjercicios(); renderChartSelectors(); renderCharts(); } } }) }); }

  function cambiarFoto(id){ const ex=idToEj(id); if(!ex) return; const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.onchange=()=>{ const file=input.files?.[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ ex.imagen=reader.result; saveEjercicios(ejercicios); renderTabla(); renderListaEjercicios(); }; reader.readAsDataURL(file); }; input.click(); }

  // ====== SERIES (SETS) POR EJERCICIO ======
  function getReg(f, id){ const r=ensureFecha(f); if(!r[id]) r[id]={sets:[], notas:''}; const x=r[id]; if(!x.sets) x.sets=[]; if(x.peso||x.reps){ if(x.sets.length===0){ x.sets.push({peso:x.peso||'', reps:x.reps||''}); } delete x.peso; delete x.reps; saveRegistros(registros);} return x; }

  function serieHtml(id, idx, s){
    return `<div class='set' data-id='${id}' data-idx='${idx}'>
      <span class='muted'>S${idx+1}</span>
      <div class='input'><input type='number' step='0.5' min='0' placeholder='kg' value='${s.peso||''}' data-field='peso' aria-label='Peso serie ${idx+1}'/></div>
      ×
      <div class='input'><input type='number' step='1' min='0' placeholder='reps' value='${s.reps||''}' data-field='reps' aria-label='Reps serie ${idx+1}'/></div>
      <button class='rm' title='Eliminar serie' aria-label='Eliminar serie'>&times;</button>
    </div>`;
  }

  function defaultYouTubeSearch(nombre){
    const q = encodeURIComponent(`${nombre} técnica correcta gym español`);
    return `https://www.youtube.com/results?search_query=${q}`;
  }

  function renderTabla(){ const tb=$('#tbody'); tb.innerHTML=''; const lista=getLista(fecha); if(!lista.length){ tb.innerHTML = `<tr><td colspan='5' class='muted' style='padding:18px'>No hay ejercicios para esta fecha. Usa <b>Cargar plantilla</b> o <b>Añadir ejercicio</b>.</td></tr>`; return; }
    lista.forEach(id=>{ const ex=idToEj(id); if(!ex) return; const reg=getReg(fecha, id); const link = (ex.video && /^https?:\/\//i.test(ex.video)) ? ex.video : defaultYouTubeSearch(ex.nombre);
      const tr=document.createElement('tr'); tr.innerHTML=`
      <td>
        <div class='ex-cell'>
          <div class='thumb' role='img' aria-label='Imagen del ejercicio'><img src='${ex.imagen || svgPlaceholder(ex.nombre)}' alt='${ex.nombre}'/></div>
          <div>
            <div class='ex-name'><a class='ex-link' href='${link}' target='_blank' rel='noopener'>${ex.nombre}</a></div>
            <div class='muted'>${ex.categoria||''}</div>
          </div>
        </div>
      </td>
      <td><div class='muted'>${ex.objetivo||''}</div></td>
      <td>
        <div class='sets' id='sets-${id}'>
          ${reg.sets.map((s,idx)=> serieHtml(id, idx, s)).join('')}
        </div>
        <div style='margin-top:8px'><button class='add-set tiny btn ghost' data-id='${id}'>+ Añadir serie</button></div>
      </td>
      <td><div class='input' style='width:100%'><input type='text' placeholder='Notas (opcional)' value='${(reg.notas||'').replaceAll("'","&#39;")}' data-id='${id}' data-field='notas' style='width:100%'/></div></td>
      <td class='actions'>
        <button class='btn secondary tiny' data-action='foto' data-id='${id}'>Cambiar foto</button>
        <button class='btn ghost tiny' data-action='quitar' data-id='${id}'>Quitar del día</button>
      </td>`;
      tb.appendChild(tr);
    });

    // Inputs de notas
    tb.querySelectorAll('input[data-field="notas"]').forEach(inp=>{ inp.addEventListener('input', ()=>{ const id=inp.dataset.id; const r=getReg(fecha,id); r.notas=inp.value; saveRegistros(registros); }) });

    // Manejo de series
    lista.forEach(id=> attachSetHandlers(id));

    // Acciones
    tb.querySelectorAll('button').forEach(btn=>{
      const action=btn.dataset.action; const id=btn.dataset.id; if(!action) return;
      btn.addEventListener('click', ()=>{
        if(action==='quitar'){ if(confirm('¿Quitar este ejercicio de la sesión de hoy?')){ const lista=getLista(fecha).filter(x=>x!==id); setLista(fecha, lista); renderTabla(); renderCharts(); } }
        if(action==='foto'){ cambiarFoto(id); }
      })
    })
  }

  function attachSetHandlers(id){
    const container = document.getElementById('sets-'+id);
    const addBtn = container?.parentElement?.querySelector('.add-set[data-id="'+id+'"]');
    if(addBtn){ addBtn.onclick = ()=>{ const r=getReg(fecha,id); const last=r.sets[r.sets.length-1]||{peso:'', reps:''}; r.sets.push({peso:last.peso, reps:last.reps}); saveRegistros(registros); renderTabla(); renderCharts(); } }
    if(!container) return;
    container.querySelectorAll('.set').forEach(el=>{
      const idx=parseInt(el.dataset.idx); const r=getReg(fecha,id);
      el.querySelector('.rm').onclick = ()=>{ r.sets.splice(idx,1); saveRegistros(registros); renderTabla(); renderCharts(); }
      el.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', ()=>{ const field=inp.dataset.field; const val=inp.value; r.sets[idx][field]=val; saveRegistros(registros); renderCharts(); })
      })
    })
  }

  function updatePlanSelectFromFecha(){ const code=getPlan(fecha); if(code && PLANTILLAS[code]){ planSelect.value=code; } }

  // ===== PROGRESO SEMANAL (SOLO MEJOR PESO POR EJERCICIO) + TOOLTIP =====
  function weekStart(date){ const d=new Date(date+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }
  function yyyymmdd(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}` }
  function weekLabel(d){ const m=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; return `${String(d.getDate()).padStart(2,'0')} ${m[d.getMonth()]}` }

  function gatherWeeksMax(exId, maxWeeks=8){ const entries=Object.keys(registros).filter(k=>/\d{4}-\d{2}-\d{2}/.test(k)).sort(); if(!entries.length || !exId) return {labels:[], maxPeso:[]}; const lastDateISO=entries[entries.length-1]; const lastStart=weekStart(lastDateISO); const starts=[]; for(let i=maxWeeks-1;i>=0;i--){ const d=new Date(lastStart); d.setDate(d.getDate()-i*7); starts.push(d); } const weekKeys=starts.map(d=>yyyymmdd(d)); const data={}; weekKeys.forEach(k=> data[k]=0); entries.forEach(dateISO=>{ const ws=yyyymmdd(weekStart(dateISO)); if(!(ws in data)) return; const rec=registros[dateISO]; const lista=rec._lista||[]; lista.forEach(id=>{ if(id!==exId) return; const r=rec[id]; if(!r) return; const sets=r.sets||[]; sets.forEach(s=>{ const peso=parseFloat(s.peso||'0')||0; if(peso>0){ data[ws] = Math.max(data[ws], peso); } }); }); }); const labels=starts.map(d=>weekLabel(d)); const maxPeso=starts.map(d=> Math.round((data[yyyymmdd(d)]||0)*10)/10 ); return {labels, maxPeso}; }

  function clearCanvas(c){ const ctx=c.getContext('2d'); const dpr=window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,c.clientWidth,c.clientHeight); return ctx; }
  function drawAxes(ctx,w,h,p){ ctx.strokeStyle='rgba(148,163,184,0.35)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(p,p); ctx.lineTo(p,h-p); ctx.lineTo(w-p,h-p); ctx.stroke(); }
  function niceMax(v){ if(v<=0) return 10; const pow=Math.pow(10, Math.floor(Math.log10(v))); const n=[1,2,5,10]; for(let f of n){ if(v<=f*pow) return f*pow; } return 10*pow; }

  function ensureTooltipFor(canvas){ if(canvas._tip) return canvas._tip; const wrap=canvas.parentElement; const tip=document.createElement('div'); tip.className='tooltip'; tip.style.display='none'; wrap.appendChild(tip); canvas._tip=tip; return tip; }
  function showTip(canvas, x, y, html){ const tip=ensureTooltipFor(canvas); tip.innerHTML=html; tip.style.left = x+'px'; tip.style.top = y+'px'; tip.style.display='block'; }
  function hideTip(canvas){ const tip=ensureTooltipFor(canvas); tip.style.display='none'; }

  function drawLineChart(canvas, labels, values, color='#38bdf8'){
    const ctx=clearCanvas(canvas); const w=canvas.clientWidth, h=canvas.clientHeight; const p=36; const max=niceMax(Math.max(0,...values)); const innerW=w-2*p, innerH=h-2*p; const n=Math.max(1, labels.length);
    // grid
    ctx.strokeStyle='rgba(148,163,184,0.22)'; ctx.lineWidth=1; ctx.setLineDash([4,4]); const steps=4; for(let i=1;i<=steps;i++){ const y=p+innerH*(1-i/steps); ctx.beginPath(); ctx.moveTo(p,y); ctx.lineTo(w-p,y); ctx.stroke(); } ctx.setLineDash([]);
    drawAxes(ctx,w,h,p);
    ctx.lineWidth=2; ctx.strokeStyle=color; ctx.beginPath();
    const points=[];
    for(let i=0;i<n;i++){
      const x=p + (i+0.5)*(innerW/n); const val=values[i]||0; const y=h-p - (max? (val/max)*innerH : 0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); points.push({x,y,label:labels[i]||'', value:val}); }
    ctx.stroke();
    for(const pt of points){ ctx.beginPath(); ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2); ctx.fillStyle=color; ctx.fill(); }
    ctx.fillStyle='rgba(230,244,255,0.95)'; ctx.font='12px Inter, system-ui, sans-serif'; ctx.textAlign='center'; for(let i=0;i<n;i++){ const x=p + (i+0.5)*(innerW/n); ctx.fillText(labels[i]||'', x, h-p+14); }

    canvas._hits = points; canvas._labels = labels; canvas._values = values; canvas._chartType='line'; canvas._max=max; canvas._padding=p; canvas._innerH=innerH; canvas._innerW=innerW; canvas._color=color;
    if(!canvas._events){ canvas.addEventListener('mousemove', onCanvasMove); canvas.addEventListener('mouseleave', onCanvasLeave); canvas._events=true; }
  }

  function onCanvasMove(ev){ const c=ev.currentTarget; const rect=c.getBoundingClientRect(); const x=ev.clientX-rect.left; const y=ev.clientY-rect.top; const hits=c._hits||[]; let minD=1e9, best=null; for(const pt of hits){ const dx=x-pt.x, dy=y-pt.y; const d=Math.hypot(dx,dy); if(d<minD){ minD=d; best=pt; } } if(best && minD<=12){ showTip(c, best.x, best.y, `<div class='t-title'>${best.label}</div><div class='t-sub'>Mejor peso</div><div><b>${best.value}</b> kg</div>`); return; } hideTip(c); }
  function onCanvasLeave(ev){ hideTip(ev.currentTarget); }

  function renderChartSelectors(){
    const sel=$('#sel-ej');
    const current=sel.value;
    sel.innerHTML='<option value="">— Selecciona —</option>' + ejercicios.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
    if(current && ejercicios.find(e=>e.id===current)){
      sel.value=current;
    }else{
      const listaHoy=(registros[fecha]?._lista)||[];
      if(listaHoy.length){ sel.value = listaHoy[0]; }
      else { sel.selectedIndex=0; }
    }
  }

  function renderCharts(){
    const ejId=$('#sel-ej').value;
    const weeks=parseInt($('#sel-weeks').value||'8');
    const c2=$('#chart-max');
    const lbl=$('#lbl-max');
    if(!ejId){
      const ctx=c2.getContext('2d'); ctx.clearRect(0,0,c2.width,c2.height);
      lbl.textContent='Selecciona un ejercicio';
      return;
    }
    const {labels, maxPeso}=gatherWeeksMax(ejId, weeks);
    lbl.textContent = labels.length? `Últimas ${labels.length} semanas` : 'Sin datos';
    drawLineChart(c2, labels, maxPeso);
  }

  $('#btn-actualizar').addEventListener('click', ()=> renderCharts());
  $('#sel-ej').addEventListener('change', ()=> renderCharts());
  $('#sel-weeks').addEventListener('change', ()=> renderCharts());

  // Init
  renderTabla(); updatePlanSelectFromFecha(); renderChartSelectors(); renderCharts();
})();
</script>
</body>
</html>